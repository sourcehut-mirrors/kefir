image: ubuntu/jammy
packages:
  - build-essential
  - gcc-12
  - valgrind
sources:
  - https://git.sr.ht/~jprotopopov/kefir
tasks:
  - bootstrap: |
      cd kefir
      make clean clean_bootstrap
      export KEFIR_RTLIB="$HOME/kefir/bin/libs/libkefirrt.a"
      export KEFIR_RTINC="$HOME/kefir/headers/kefir/runtime"
      export KEFIR_GNU_INCLUDE="/usr/lib/gcc/x86_64-linux-gnu/12/include;/usr/include/x86_64-linux-gnu;/usr/include;/usr/local/include"
      export KEFIR_GNU_LIB="/usr/lib/x86_64-linux-gnu;/usr/lib/gcc/x86_64-linux-gnu/12/;/usr/lib;/usr/local/lib"
      export KEFIR_GNU_DYNAMIC_LINKER="/lib64/ld-linux-x86-64.so.2"
      LC_ALL=C.UTF-8 make bootstrap KEFIR_EXTRAFLAGS="--target opt-x86_64-host-gnu -Woptimizer-pipeline=compare-branch-fuse" -j$(nproc)
triggers:
  - action: email
    condition: failure
    to: jevgenij@protopopov.lv
