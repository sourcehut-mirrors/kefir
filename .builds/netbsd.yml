image: netbsd/10.x
packages:
  - gmake
  - binutils
  - coreutils
  - bash
  - wget
  - python311
  - libatomic
sources:
  - https://git.sr.ht/~jprotopopov/kefir
tasks:
  - test_self: |
      cd kefir
      gmake clean
      gmake all CC=gcc AS=gas
      gmake install prefix=$HOME/kefir-install
      gmake clean
      export LC_ALL=C.UTF-8
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/pkg/lib
      export LIBRARY_PATH=$LIBRARY_PATH:/usr/pkg/lib
      gmake all PROFILE=reldebug CC=$HOME/kefir-install/bin/kefir AS=gas EXTRA_CFLAGS="-D__GNUC__=4 -D__GNUC_MINOR__=20 -D__GNUC_STDC_INLINE__=1 -include headers/bootstrap_include/netbsd.h" EXTRA_LDFLAGS="-L/usr/pkg/lib"
      LC_ALL=C.UTF-8 gmake test PROFILE=reldebug CC=$HOME/kefir-install/bin/kefir  AS=gas EXTRA_CFLAGS="-D__GNUC__=4 -D__GNUC_MINOR__=20 -D__GNUC_STDC_INLINE__=1 -include headers/bootstrap_include/netbsd.h" EXTRA_LDFLAGS="-L/usr/pkg/lib"
  - test: |
      cd kefir
      export LC_ALL=C.UTF-8
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/pkg/lib
      export LIBRARY_PATH=$LIBRARY_PATH:/usr/pkg/lib
      gmake clean
      gmake test all CC=gcc AS=gas PROFILE=reldebug
  - lua_tests: |
      cd kefir
      export LIBRARY_PATH=$LIBRARY_PATH:/usr/pkg/lib
      export LC_ALL=C.UTF-8
      gmake bin/tests/external/lua.test.done REALPATH=grealpath KEFIR_EXTERNAL_TEST_LUA_CFLAGS="-O1 -fPIC -pie -D__GNUC__=4 -D__GNUC_MINOR__=20 -D__GNUC_STDC_INLINE__=1 -include $HOME/kefir/headers/bootstrap_include/netbsd.h"
  - c_testsuite: |
      cd kefir
      mkdir -p "$HOME/bin"
      ln -s "$(which python3.11)" "$HOME/bin/python3"
      export PATH="$HOME/bin:$PATH"
      export LC_ALL=C.UTF-8 
      gmake bin/tests/external/c-testsuite.test.done KEFIR_EXTERNAL_TEST_C_TESTSUITE_CFLAGS="-O1 -fPIC -pie -D__GNUC__=4 -D__GNUC_MINOR__=20 -D__GNUC_STDC_INLINE__=1"
  - gcc_torture: |
      cd kefir
      export LC_ALL=C.UTF-8
      gmake bin/tests/external/gcc-torture.test.done AS=gas KEFIR_EXTERNAL_TEST_GCC_TORTURE_CFLAGS="-O1 -fPIC -pie -D__GNUC__=4 -D__GNUC_MINOR__=20 -D__GNUC_STDC_INLINE__=1 -include $HOME/kefir/headers/bootstrap_include/netbsd.h"
  - bootstrap: |
      cd kefir
      gmake clean
      export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/pkg/lib:$HOME/kefir/bin/libs"
      export LIBRARY_PATH=$LIBRARY_PATH:/usr/pkg/lib
      export KEFIR_RTINC="$HOME/kefir/headers/kefir/runtime"
      export REALPATH=grealpath
      LC_ALL=C.UTF-8 gmake bootstrap AS=gas BOOTSTRAP_EXTRA_CFLAGS="-O1 -g"
triggers:
  - action: email
    condition: failure
    to: jevgenij@protopopov.lv
