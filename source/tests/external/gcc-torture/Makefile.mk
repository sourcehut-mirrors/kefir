KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR := $(KEFIR_EXTERNAL_TESTS_DIR)/gcc-torture

KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION := 15.1.0

KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME := gcc-$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION).tar.xz
KEFIR_EXTERNAL_TEST_GCC_URL := https://ftp.mpi-inf.mpg.de/mirrors/gnu/mirror/gcc.gnu.org/pub/gcc/releases/gcc-$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION)/gcc-$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION).tar.xz
KEFIR_EXTERNAL_TEST_GCC_ARCHIVE := $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)/$(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME)
KEFIR_EXTERNAL_TEST_GCC_DIR := $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)/gcc-$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION)

KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_SHA256 := e2b09ec21660f01fecffb715e0120265216943f038d0e48a9868713e54f06cea

KEFIR_EXTERNAL_TEST_GCC_TORTURE_CFLAGS := -O1 -fPIC -pie -g

$(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE):
	@mkdir -p "$(dir $@)"
	@echo "Downloading $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME)..."
	@wget -O "$@.tmp" "$(KEFIR_EXTERNAL_TEST_GCC_URL)"
	@$(SCRIPTS_DIR)/checksum_sha256.sh "$@.tmp" "$(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_SHA256)"
	@mv "$@.tmp" "$@"

$(KEFIR_EXTERNAL_TEST_GCC_DIR)/.done: $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE)
	@echo "Unpacking $(basename $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE))..."
	@rm -rf "$(KEFIR_EXTERNAL_TEST_GCC_DIR)"
	@cd "$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)" && \
		rm -f "$(basename $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME))" && \
		xz -d < "$(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME)" > "$(basename $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME))"
	@cd "$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)" && tar xvf "$(basename $(KEFIR_EXTERNAL_TEST_GCC_ARCHIVE_FILENAME))"
	@touch "$@"

$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)/torture.log: $(KEFIR_EXTERNAL_TEST_GCC_DIR)/.done $(KEFIR_EXE)
	@echo "Running GCC $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION) torture test suite..."
	@TORTURE="$(KEFIR_EXTERNAL_TEST_GCC_DIR)/gcc/testsuite/gcc.c-torture" \
		KEFIRCC="$(realpath $(KEFIR_EXE))" \
		LD_LIBRARY_PATH="$(realpath $(LIB_DIR)):$$LD_LIBRARY_PATH" \
		KEFIR_RTINC="$(realpath $(HEADERS_DIR)/kefir/runtime)" \
		KEFIR_EXTRAFLAGS="$(KEFIR_EXTERNAL_TEST_GCC_TORTURE_CFLAGS)" \
		"$(SOURCE_DIR)/tests/external/gcc-torture/runner.sh" "$@"

$(KEFIR_EXTERNAL_TESTS_DIR)/gcc-torture.test.done: $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_DIR)/torture.log
	@echo "Succesfully validated GCC $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION) torture test suite results..."
	@touch "$@"
	@echo "GCC $(KEFIR_EXTERNAL_TEST_GCC_TORTURE_VERSION) torture test suite successfully finished"

KEFIR_GCC_TORTURE_TEST = $(KEFIR_EXTERNAL_TESTS_DIR)/gcc-torture.test.done
EXTERNAL_TESTS_BASE_SUITE += $(KEFIR_EXTERNAL_TESTS_DIR)/gcc-torture.test.done
