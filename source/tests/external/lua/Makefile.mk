KEFIR_EXTERNAL_TEST_LUA_DIR := $(KEFIR_EXTERNAL_TESTS_DIR)/lua

KEFIR_EXTERNAL_TEST_LUA_VERSION := 5.4.8
KEFIR_EXTERNAL_TEST_LUA_ARCHIVE := lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION).tar.gz
KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE := lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)-tests.tar.gz
KEFIR_EXTERNAL_TEST_LUA_URL := https://www.lua.org/ftp/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION).tar.gz
KEFIR_EXTERNAL_TEST_LUA_TESTS_URL := https://www.lua.org/tests/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)-tests.tar.gz

KEFIR_EXTERNAL_TEST_LUA_ARCHIVE_SHA256=4f18ddae154e793e46eeab727c59ef1c0c0c2b744e7b94219710d76f530629ae
KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE_SHA256=9581d5a7c39ffbf29b8ccde2709083c380f7bbddbd968dcb15712d2f2e33f4e5

KEFIR_EXTERAL_TEST_LUA_EXE := $(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)/src/lua
KEFIR_EXTERAL_TEST_LUA_TEST_SUITE := $(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)-tests/.extracted

KEFIR_EXTERNAL_TEST_LUA_CFLAGS := -O1 -fPIC -pie

$(KEFIR_EXTERNAL_TEST_LUA_DIR)/$(KEFIR_EXTERNAL_TEST_LUA_ARCHIVE):
	@mkdir -p $(shell dirname $@)
	@echo "Downloading $(KEFIR_EXTERNAL_TEST_LUA_URL)..."
	@wget -O "$@.tmp" "$(KEFIR_EXTERNAL_TEST_LUA_URL)"
	@$(SCRIPTS_DIR)/checksum_sha256.sh "$@.tmp" "$(KEFIR_EXTERNAL_TEST_LUA_ARCHIVE_SHA256)"
	@mv "$@.tmp" "$@"

$(KEFIR_EXTERNAL_TEST_LUA_DIR)/$(KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE):
	@mkdir -p $(shell dirname $@)
	@echo "Downloading $(KEFIR_EXTERNAL_TEST_LUA_TESTS_URL)..."
	@wget -O "$@.tmp" "$(KEFIR_EXTERNAL_TEST_LUA_TESTS_URL)"
	@$(SCRIPTS_DIR)/checksum_sha256.sh "$@.tmp" "$(KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE_SHA256)"
	@mv "$@.tmp" "$@"

$(KEFIR_EXTERAL_TEST_LUA_EXE): $(KEFIR_EXTERNAL_TEST_LUA_DIR)/$(KEFIR_EXTERNAL_TEST_LUA_ARCHIVE) $(KEFIR_EXE)
	@echo "Building Lua $(KEFIR_EXTERNAL_TEST_LUA_VERSION)..."
	@rm -rf "$(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)"
	@cd "$(KEFIR_EXTERNAL_TEST_LUA_DIR)" && tar xvfz "$(KEFIR_EXTERNAL_TEST_LUA_ARCHIVE)"
	@cd "$(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)" && \
		LD_LIBRARY_PATH="$(shell $(REALPATH) $(LIB_DIR)):$$LD_LIBRARY_PATH" \
		KEFIR_RTINC="$(shell $(REALPATH) $(HEADERS_DIR)/kefir/runtime)" \
			$(MAKE) -f Makefile \
			CC="$(shell $(REALPATH) $(KEFIR_EXE))" \
			CFLAGS="$(KEFIR_EXTERNAL_TEST_LUA_CFLAGS)" \
			posix

$(KEFIR_EXTERAL_TEST_LUA_TEST_SUITE): $(KEFIR_EXTERNAL_TEST_LUA_DIR)/$(KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE)
	@echo "Extracting Lua $(KEFIR_EXTERNAL_TEST_LUA_VERSION) tests..."
	@rm -rf "$(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)-tests"
	@cd "$(KEFIR_EXTERNAL_TEST_LUA_DIR)" && tar xvfz "$(KEFIR_EXTERNAL_TEST_LUA_TESTS_ARCHIVE)"
	@cd "$(KEFIR_EXTERNAL_TEST_LUA_DIR)/lua-$(KEFIR_EXTERNAL_TEST_LUA_VERSION)-tests" && patch < "$(shell $(REALPATH) $(SOURCE_DIR)/tests/external/lua/lua-5.4.6-tests.patch)"
	@touch "$@"

$(KEFIR_EXTERNAL_TESTS_DIR)/lua.test.done: $(KEFIR_EXTERAL_TEST_LUA_EXE) $(KEFIR_EXTERAL_TEST_LUA_TEST_SUITE)
	@echo "Running Lua $(KEFIR_EXTERNAL_TEST_LUA_VERSION) test suite..."
	@cd "$(shell dirname $(KEFIR_EXTERAL_TEST_LUA_TEST_SUITE))" && "$(shell $(REALPATH) $(KEFIR_EXTERAL_TEST_LUA_EXE))" -e"_U=true" all.lua
	@touch "$@"
	@echo "Lua $(KEFIR_EXTERNAL_TEST_LUA_VERSION) test suite successfully finished"

EXTERNAL_TESTS_BASE_SUITE += $(KEFIR_EXTERNAL_TESTS_DIR)/lua.test.done
