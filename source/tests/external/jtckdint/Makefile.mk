
KEFIR_EXTERNAL_TEST_JTCKDINT_DIR := $(KEFIR_EXTERNAL_TESTS_DIR)/jtckdint

KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION := d4c68b9559acdcc18b73c9fa463edc6b9c569c9f
KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_FILENAME := $(KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION).zip
KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE := $(KEFIR_EXTERNAL_TEST_JTCKDINT_DIR)/$(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_FILENAME)
KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR := $(KEFIR_EXTERNAL_TEST_JTCKDINT_DIR)/jtckdint-$(KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION)
KEFIR_EXTERNAL_TEST_JTCKDINT_URL := https://github.com/jart/jtckdint/archive/$(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_FILENAME)

KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_SHA256 := ab67a8530a848f0101caab76e91dec704681d80b8d2bc353be6ba9f586cf72a3

$(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE):
	@mkdir -p $(dir $@)
	@echo "Downloading $(KEFIR_EXTERNAL_TEST_JTCKDINT_URL)"
	@wget -O "$@.tmp" "$(KEFIR_EXTERNAL_TEST_JTCKDINT_URL)"
	@$(SCRIPTS_DIR)/checksum_sha256.sh "$@.tmp" "$(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_SHA256)"
	@mv "$@.tmp" "$@"

$(KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR)/.extracted: $(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE)
	@echo "Extracting $(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_FILENAME)..."
	@cd "$(KEFIR_EXTERNAL_TEST_JTCKDINT_DIR)" && unzip -o "$(KEFIR_EXTERNAL_TEST_JTCKDINT_ARCHIVE_FILENAME)"
	@echo "Patching jtckdint $(KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION)..."
	@cd "$(KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR)" && patch -p0 < "$(realpath $(SOURCE_DIR))/tests/external/jtckdint/jtckdint.patch"
	@touch $@

$(KEFIR_EXTERNAL_TESTS_DIR)/jtckdint.test.done: $(KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR)/.extracted $(KEFIR_EXE)
	@echo "Testing jtckdint $(KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION)..."
	cd "$(KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR)" && \
		LD_LIBRARY_PATH="$(realpath $(LIB_DIR)):$$LD_LIBRARY_PATH" \
		KEFIR_RTINC="$(realpath $(HEADERS_DIR))/kefir/runtime" \
		$(realpath $(KEFIR_EXE)) -c -o test.o test.c -D__STRICT_ANSI__=1 "-D__ckd_intmax=long long" -O0
	@cd "$(KEFIR_EXTERNAL_TEST_JTCKDINT_SOURCE_DIR)" && \
		LD_LIBRARY_PATH="$(realpath $(LIB_DIR)):$$LD_LIBRARY_PATH" \
		KEFIR_RTINC="$(realpath $(HEADERS_DIR))/kefir/runtime" \
		CC="$(realpath $(KEFIR_EXE))" \
		$(MAKE)
	@touch "$@"
	@echo "Successfully tested jtckdint $(KEFIR_EXTERNAL_TEST_JTCKDINT_VERSION)"

EXTERNAL_TESTS_FAST_SUITE += $(KEFIR_EXTERNAL_TESTS_DIR)/jtckdint.test.done
